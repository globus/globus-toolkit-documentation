<section id="s-aggregator-source-overview"><title>Aggregator Sources Configuration Overview</title>
<para>
  Configuration options for <glossterm linkend="aggregator-source">aggregator sources</glossterm> are specified by creating a configuration
file and running <ulink url=
  "http://www.globus.org/toolkit/docs/4.0/info/aggregator/rn01re02.html">
  mds-servicegroup-add</ulink> to perform the registrations specified in
that configuration file. See
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_aggregator/example-aggregator-registration.xml</filename>
for several specific examples. The general syntax of a <ulink url=
  "http://www.globus.org/toolkit/docs/4.0/info/aggregator/rn01re02.html">
  mds-servicegroup-add</ulink> configuration file is:
</para>
<screen>
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;ServiceGroupRegistrations
  xmlns="http://mds.globus.org/servicegroup/client"&gt;

  &lt;<emphasis>defaultServiceGroupEPR</emphasis>&gt;
    <emphasis>Default service group EPR</emphasis>
  &lt;/<emphasis>defaultServiceGroupEPR</emphasis>&gt;

  &lt;<emphasis>defaultRegistrantEPR</emphasis>&gt;
    <emphasis>Default registrant EPR</emphasis>
  &lt;/<emphasis>defaultRegistrantEPR</emphasis>&gt;

  &lt;<emphasis>defaultSecurityDescriptorFile</emphasis>&gt;
    <emphasis>Path name of security descriptor file</emphasis>
  &lt;/<emphasis>defaultSecurityDescriptorFile</emphasis>&gt;

  <emphasis>One or more of the following:</emphasis>
  &lt;<emphasis>ServiceGroupRegistrationParameters</emphasis>&gt;
    &lt;<emphasis>ServiceGroupEPR</emphasis>&gt;
      <emphasis>EPR of the service group to register to</emphasis>
    &lt;<emphasis>/ServiceGroupEPR</emphasis>&gt;
    &lt;<emphasis>RegistrantEPR</emphasis>&gt;
      <emphasis>EPR of the entity to be monitored.</emphasis>
    &lt;<emphasis>/RegistrantEPR</emphasis>&gt;
    &lt;<emphasis>InitialTerminationTime</emphasis>&gt;
      <emphasis>Initial termination time</emphasis>
    &lt;<emphasis>/InitialTerminationTime</emphasis>&gt;
    &lt;<emphasis>RefreshIntervalSecs</emphasis>&gt;
      <emphasis>Refresh interval, in seconds</emphasis>
    &lt;<emphasis>/RefreshIntervalSecs</emphasis>&gt;
    &lt;<emphasis>Content</emphasis>&gt;
      <emphasis>Aggregator-source-specific configuration parameters</emphasis>
    &lt;<emphasis>/Content</emphasis>&gt;
  &lt;/<emphasis>ServiceGroupRegistrationParameters</emphasis>&gt;

&lt;/ServiceGroupRegistrations&gt;
</screen>
<para>The following table describes the different blocks of the file
and any parameters:</para>
<table><title>Aggregator configuration parameters</title>
<tgroup cols="1"><tbody>
<row>
<entry><constant>defaultServiceGroupEPR</constant> block</entry>
<entry>The provides a convenient way to register a number
of resources to a single service group -- for example, if you wish
to register several resources to your default VO index, you can
specify that index as the default service group and omit the
<constant>ServiceGroupEPR</constant> blocks from each
<constant>ServiceGroupRegistrationParameters</constant> block.</entry>
</row>
<row>
<entry><constant>defaultRegistrantEPR</constant></entry>
<entry>The provides a convenient way to register a single
resource to several service groups -- for example, if you wish to
register your local GRAM server to several index servers, you can
specify your GRAM server as the default registrant and omit the
<constant>RegistrantEPR</constant> blocks from each
<constant>ServiceGroupRegistrationParameters</constant> block.</entry>
</row>
<row>
<entry><constant>defaultSecurityDescriptorFile</constant></entry>
<entry>Simply the path to the <ulink url=
"http://www-unix.globus.org/toolkit/docs/4.0/security/authzframe/security_descriptor.html">
security descriptor file</ulink>.</entry>
</row>
<row>
<entry>
<constant>ServiceGroupRegistrationParameters</constant></entry>
<entry>Each
<constant>ServiceGroupRegistrationParameters</constant> block specifies the
parameters used to register a resource to a service group. The
parameters specified in this block are:</entry>
</row>
<row>
<entry><constant>ServiceGroupEPR</constant></entry>
<entry>The EPR of the service group to register to. This parameter may
be omitted if a <constant>defaultServiceGroupEPR</constant> block is
specified; in this case, the value of
<constant>defaultServiceGroupEPR</constant> will be used instead.</entry>
</row>
<row>
<entry><constant>RegistrantEPR</constant></entry>
<entry>The EPR of the resource to register. This parameter may be
omitted if a <constant>defaultRegistrantEPR</constant> block is specified;
in this case, the value of <constant>defaultRegistrantEPR</constant> will
be used instead.</entry>
</row>
<row>
<entry><constant>InitialTerminationTime</constant></entry>
<entry>The initial termination time of this registration (this may be
omitted). If the initial termination time is omitted, then the
<ulink url=
  "http://www.globus.org/toolkit/docs/4.0/info/aggregator/rn01re02.html">
  mds-servicegroup-add</ulink> sets the initial termination time to the
current wall time plus 2 times that of the specified
<constant>RefreshIntervalSecs</constant> parameter.</entry>
</row>
<row>
<entry><constant>RefreshIntervalSecs</constant></entry>
<entry>The refresh interval of the registration, in seconds. The
<ulink url=
  "http://www.globus.org/toolkit/docs/4.0/info/aggregator/rn01re02.html">
  mds-servicegroup-add</ulink> will attempt to refresh the registration
according to this interval, by default incrementing the termination
time of the registration by 2 times this interval for every
successful refresh. If at any point the termination time for the
registration expires the registration will be subject to removal
within a maximum of 5 minutes.</entry>
</row>
<row>
<entry><constant>Content</constant></entry>
<entry>Aggregator-source-specific registration parameters. The content
blocks for the various aggregator sources are described in detail
in the following sections.</entry>
</row>
</tbody></tgroup>
</table>
</section> 
<section id="s-globus-aggregator-sources"><title>Configuration Details for Aggregator Sources Included in the Globus Toolkit</title>
The following subsections describe configuration details for the
<ulink url="#s-aggregator-query-source">Query Aggregator Source</ulink>,
<ulink url="#s-aggregator-subscription-source">Subscription Aggregator Source</ulink>, and
<ulink url="#s-aggregator-execution-source">Execution Aggregator Source</ulink>.
 <section id="s-aggregator-query-source"><title>Configuring the Query Aggregator Source</title>
<para>The QueryAggregatorSource can use one of the following three
configuration blocks:</para>
<itemizedlist>
<listitem><simpara><ulink url=
"#GetResourcePropertyPollType">GetResourcePropertyPollType</ulink></simpara></listitem>
<listitem><simpara><ulink url=
"#GetMultipleResourcePropertiesPollType">GetMultipleResourcePropertiesPollType</ulink></simpara></listitem>
<listitem><simpara><ulink url=
"#QueryResourcePropertiesPollType">QueryResourcePropertiesPollType</ulink></simpara></listitem>
</itemizedlist>
<section id="GetResourcePropertyPollType"><title>
GetResourcePropertyPollType</title>
<para>
If a <constant>GetResourcePropertyPollType</constant> block is used,
QueryAggregatorSource will request a single resource property. The
block has this form:
<screen>
&lt;Content xsi:type="agg:AggregatorContent"
  xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
  &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
    &lt;agg:GetResourcePropertyPollType&gt;
      &lt;agg:<emphasis>PollIntervalMillis</emphasis>&gt;<emphasis>interval_in_ms</emphasis>&lt;/agg:<emphasis>PollIntervalMillis</emphasis>&gt;
      &lt;agg:<emphasis>ResourcePropertyName</emphasis>&gt;<emphasis>rp_namespace</emphasis>:<emphasis>rp_localname</emphasis>&lt;/agg:<emphasis>ResourcePropertyName</emphasis>&gt;
    &lt;/agg:GetResourcePropertyPollType&gt;
  &lt;/agg:AggregatorConfig&gt;
  &lt;agg:AggregatorData/&gt;
&lt;/Content&gt;
</screen>
</para>
<para>
The <constant>PollIntervalMillis</constant> parameter is the poll refresh
period in milliseconds; the <constant>ResourcePropertyName</constant>
parameter is the QName of the resource property to poll for.</para>
</section>
<section id="GetMultipleResourcePropertiesPollType"><title>
GetMultipleResourcePropertiesPollType</title>
<para>
If a <constant>GetMultipleResourcePropertiesPollType</constant> block is
used, <constant>QueryAggregatorSource</constant> will request one or more
resource properties. The block has this form:
<screen>
&lt;Content
    xmlns:agg="http://mds.globus.org/aggregator/types"
    xsi:type="agg:AggregatorContent"&gt;
  &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
    &lt;agg:GetMultipleResourcePropertiesPollType&gt;
      &lt;agg:<emphasis>PollIntervalMillis</emphasis>&gt;<emphasis>interval_in_ms</emphasis>&lt;/agg:<emphasis>PollIntervalMillis</emphasis>&gt;
      &lt;agg:<emphasis>ResourcePropertyNames</emphasis>&gt;<emphasis>rp1_namespace</emphasis>:<emphasis>rp1_localname</emphasis>&lt;/agg:<emphasis>ResourcePropertyNames</emphasis>&gt;
      &lt;agg:<emphasis>ResourcePropertyNames</emphasis>&gt;<emphasis>rp2_namespace</emphasis>:<emphasis>rp3_localname</emphasis>&lt;/agg:<emphasis>ResourcePropertyNames</emphasis>&gt;
      &lt;agg:<emphasis>ResourcePropertyNames</emphasis>&gt;<emphasis>rp3_namespace</emphasis>:<emphasis>rp3_localname</emphasis>&lt;/agg:<emphasis>ResourcePropertyNames</emphasis>&gt;
    &lt;/agg:GetMultipleResourcePropertiesPollType&gt;
  &lt;/agg:AggregatorConfig&gt;
  &lt;agg:AggregatorData/&gt;
&lt;/Content&gt;
</screen>
</para>
<para>
The <constant>PollIntervalMillis</constant> parameter is the poll refresh
period in milliseconds; the <constant>ResourcePropertyNames</constant>
parameters are the QNames of the resource properties to poll for.
There is no limit on the number of
<constant>ResourcePropertyNames</constant> that may be specified.</para>
</section>
<section id="QueryResourcePropertiesPollType"><title>
QueryResourcePropertiesPollType</title>
<para>
If a <constant>QueryResourcePropertiesPollType</constant> block is used,
QueryAggregatorSource will request that a query be executed against
the Resource Property Set of the remote resource. In the GT4
implementation of WSRF Core, the only query language that is
supported is XPath. The block has this form:
<screen>
&lt;Content
    xmlns:agg="http://mds.globus.org/aggregator/types"
    xsi:type="agg:AggregatorContent"&gt;
  &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
    &lt;agg:QueryResourcePropertiesPollType&gt;
      &lt;agg:<emphasis>PollIntervalMillis</emphasis>&gt;<emphasis>interval_in_ms</emphasis>&lt;/agg:<emphasis>PollIntervalMillis</emphasis>&gt;
      &lt;agg:<emphasis>QueryExpression</emphasis> Dialect="<emphasis>dialect</emphasis>"&gt;
        <emphasis>Query Expression</emphasis>
      &lt;/agg:<emphasis>QueryExpression</emphasis>&gt;
    &lt;/agg:QueryResourcePropertiesPollType&gt;
  &lt;/agg:AggregatorConfig&gt;
  &lt;agg:AggregatorData/&gt;
&lt;/Content&gt;
</screen>
</para>
<para>
The <constant>PollIntervalMillis</constant> parameter is the poll refresh
period in milliseconds. The <constant>QueryExpression</constant> is an
<constant>xsd:any</constant> element; the <constant>Dialect</constant> attribute
specifies the dialect of the query expression.</para>
 </section>
</section>
 <section id="s-aggregator-subscription-source"><title>Configuring the Subscription Aggregator Source</title>
  <para>
<para>
The SubscriptionAggregatorSource gathers resource property values
from the registered resource using WS-Notification subscriptions.
The configuration block for
<constant>SubscriptionAggregatorSource</constant> looks like this:
<screen>
&lt;Content
    xmlns:agg="http://mds.globus.org/aggregator/types"
    xsi:type="agg:AggregatorContent"&gt;
  &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
    &lt;agg:AggregatorSubscriptionType&gt;
      &lt;<emphasis>TopicExpression</emphasis> Dialect="<emphasis>dialect</emphasis>"&gt;
        <emphasis>Topic Expression</emphasis>
      &lt;/<emphasis>TopicExpression</emphasis>&gt;
      &lt;Precondition Dialect="<emphasis>dialect</emphasis>"&gt;
        <emphasis>Precondition</emphasis>
      &lt;/Precondition&gt;
      &lt;Selector Dialect="<emphasis>dialect</emphasis>"&gt;
        <emphasis>Selector</emphasis>
      &lt;/Selector&gt;
      &lt;SubscriptionPolicy&gt;
        <emphasis>Subscription Policy</emphasis>
      &lt;/SubscriptionPolicy&gt;
      &lt;InitialTerminationTime&gt;<emphasis>time</emphasis>&lt;/InitialTerminationTime&gt;
    &lt;/agg:AggregatorSubscriptionType&gt;
  &lt;/agg:AggregatorConfig&gt;
  &lt;agg:AggregatorData/&gt;
&lt;/Content&gt;
</screen>
</para>
<para>
The only required parameter is the <constant>TopicExpression</constant>,
which specifies the topic expression to use in the subscription
request. [TODO: link to core notification/subscription docs ].</para>
  </para>
 </section>
 
 <section id="s-aggregator-execution-source"><title>Configuring the Execution Aggregator Source</title>
<para>
The ExecutionAggregatorSource gathers arbitrary XML information
about a registered resource by executing an external script and
passing registration as parameters. The configuration block for
<constant>ExecutionAggregatorSource</constant> looks like this:
<screen>
&lt;Content xsi:type="agg:AggregatorContent"
  xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
  &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
    &lt;agg:ExecutionPollType&gt;
      &lt;agg:<emphasis>PollIntervalMillis</emphasis>&gt;<emphasis>interval_in_ms</emphasis>&lt;/agg:<emphasis>PollIntervalMillis</emphasis>&gt;
      &lt;agg:<emphasis>ProbeName</emphasis>&gt;<emphasis>dummy_namespace</emphasis>:<emphasis>filename</emphasis>&lt;/agg:<emphasis>ProbeName</emphasis>&gt;
    &lt;/agg:ExecutionPollType&gt;
  &lt;/agg:AggregatorConfig&gt;
  &lt;agg:AggregatorData/&gt;
&lt;/Content&gt;
</screen>
</para>
<para>
The <constant>PollIntervalMillis</constant> parameter is the poll refresh
period in milliseconds. The <constant>ProbeName</constant> parameter
specifies the path name to the executable file, relative to the
<filename>$GLOBUS_LOCATION/libexec/aggrexec</filename> directory. The path
name should be specified as the local name part of this QName; the
namespace part is ignored.</para>
<para>
NOTE: If you've properly configured and registered your script for
execution but are getting errors from the container because it cannot
find the specified script, there are two likely causes.  First, make
sure that your script/program is executable and is located in the
<filename>$GLOBUS_LOCATION/libexec/aggrexec</filename> directory.
When it's specified in the configuration mentioned above, only specify
the name of the script/program, without any qualification or path.
For example, using the <constant>ProbeName</constant> as
<filename>test-script</filename> will be specifying the file
<filename>$GLOBUS_LOCATION/libexec/aggrexec/test-script</filename>
script.
</para>
<para>
The second most likely reason for an error is due to recent security
updates (that only apply to post 4.0 Globus Toolkit releases).  To
avoid allowing any user to execute arbitrary code, we've added a
name/mapping pair, which is a key/value pair that the administrator of
the running container must specify before starting the services.  To
configure this, look at the example in the
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_index/jndi-config.xml</filename>
file.  It can be viewed under the <constant>configuration</constant>
section (specifically, it's the
<constant>executableMappings</constant> section), and extend it (using
a comma delimiter between each name=value entry added) to include your
own.  Then you use the aliased/logical name that you've just made up
as the <constant>ProbeName</constant> as in the above configuration
example.
</para>
<!-- end of first level section -->
</section>
</section>
