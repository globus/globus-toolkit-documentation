<?php

$title = "Globus Toolkit Advisories";

include_once( "/mcs/globus.org/include/globus_header.inc" ); 

$version_dir = array (
    '5.2.1' => 'gt5/5.2/5.2.1',
    '5.2.0' => 'gt5/5.2/5.2.0',
    '5.0.5' => 'gt5/5.0/5.0.5',
    '5.0.4' => 'gt5/5.0/5.0.4',
    '5.0.3' => 'gt5/5.0/5.0.3',
    '5.0.2' => 'gt5/5.0/5.0.2',
    '5.0.1' => 'gt5/5.0/5.0.1',
    '5.0.0' => 'gt5/5.0/5.0.0',
    '4.2.1' => 'gt4/4.2.1',
    '4.2.0' => 'gt4/4.2.0',
    '4.0.8' => 'gt4/4.0/4.0.8',
    '4.0.7' => 'gt4/4.0/4.0.7',
    '4.0.6' => 'gt4/4.0/4.0.6',
    '4.0.5' => 'gt4/4.0/4.0.5',
    '4.0.4' => 'gt4/4.0/4.0.4',
    '4.0.3' => 'gt4/4.0/4.0.3',
    '4.0.2' => 'gt4/4.0/4.0.2',
    '4.0.1' => 'gt4/4.0/4.0.1',
    '4.0.0' => 'gt4/4.0/4.0.0',
    '3.2.1' => 'gt3/3.2/3.2.1',
    '3.2.0' => 'gt3/3.2/3.2.0',
    '3.0.2' => 'gt3/3.0/3.0.2',
    '3.0.1' => 'gt3/3.0/3.0.1',
    '3.0.0' => 'gt3/3.0/3.0.0',
    '2.4.0' => 'gt2/2.4/2.4.0',
    '2.4.1' => 'gt2/2.4/2.4.1',
    '2.4.2' => 'gt2/2.4/2.4.2',
    '2.4.3' => 'gt2/2.4/2.4.3',
    '2.2.4' => 'gt2/2.2/2.2.4',
    '2.2.3' => 'gt2/2.2/2.2.3',
    '2.2.2' => 'gt2/2.2/2.2.2'
);

$major_releases =
    array_unique(
        array_map(
            "major_release", array_keys($version_dir)));
arsort($major_releases);

if ( isset( $_GET['version'] ) )
{
    $get_version = $_GET['version'];
}
else
{
    $get_version = major_release($major_releases[0]);
}


$versions = "";
$count = 0;
foreach ($major_releases as $i)
{
    $unsupported = "";
    if (++$count > 2)
    {
        $supported = " [unsupported]";
    }
    $versions = $versions . "<option value=\"$i\"";
    if (preg_match("/$get_version/", $i))
    {
        $versions = $versions . " selected";
    }
    $versions = $versions . ">Globus Toolkit $i$supported</options>\n";
}
?>

<h1><?php echo $title; ?></h1>

<p>To install update packages, use "gpt-build -update <package>
<flavors>".  To find the flavors of the package which are already
installed, use "gpt-query <package-name>".  It can be quite slow to return
the output, so please be patient.</p>

<p>For instance, if you gpt-query globus_openssl_module from
a binary installation, you will find that it is installed in the
gcc32dbg and gcc32dbgpthr flavors.  Thus, to install the update named
globus_openssl_module-0.2.tar.gz, you would run "gpt-build -update
globus_openssl_module-0.2.tar.gz gcc32dbgpthr gcc32dbg".  In general
you should list the "pthr" flavor before the non-pthr flavor.</p>

<p>If gpt-query includes a "noflavor" version, you do not have to
specify an additional flavor for that.</p>

<?php
  if (substr($get_version, 0, 2) == '4.') {
?>
<p>To install GAR updates for 4.0.x or 4.2.x, run globus-deploy-gar &lt;gar&gt;</p>
<?php
  }

  if (substr($get_version, 0, 2) == '3.') {
?>
<p>To install GAR updates for 3.x, run 'ant deployGar -Dgar.id=&lt;gar&gt;' from
your GLOBUS_LOCATION.</p>
<?php
}
?>


<br>

<form action="advisories.html" method="get">
<select name="version">
<?php echo $versions; ?></select>
<input type="submit" value="Submit">
</form>

<!-- Layout Table -->
<table>
<tr>
<td>
<!-- ------------ -->

<p>
<table border=0 cellpadding=0 cellspacing=0 align=left width=700>
<tr>
<td>
    <table bgcolor=#d5d5ff border=0 cellpadding=1 cellspacing=0 width=100%>
    <tr>
    <td>
        <table cellpadding="4" cellspacing="0" border="0" width="100%">
        <tr bgcolor=#ffffff>
        <td valign=bottom class=title>Date</td>
        <td valign=bottom class=title>Package</td>
        <td valign=bottom class=title>Toolkit<br>Version</td>
        <td valign=bottom> </td>
        <td valign=bottom class=title>Description</td>
<?php
    $fd = fopen( "advisories.txt", "r" );

    $toggle_color = 1;
    while ( !feof( $fd ) )
    {
        $date = "";
        $name = "";
        $ver = "";
        $type = "";
        $description = "";

        $buffer = fgets( $fd, 4096 );
        if ( preg_match( "/^\s*$/", $buffer ) )
        {
            next;
        }
        else if ( eregi( "^#", $buffer ) )
        {
            next;
        }
        else 
        {
            list( $date, $name, $ver, $type, $description ) = explode( ";", $buffer );
            if ( preg_match( "/^$get_version/", $ver ) )
            {
                if ( $toggle_color )
                {
                    print "<tr bgcolor=#e5e5ff>\n";
                    $toggle_color = 0;
                }
                else
                {
                    print "<tr bgcolor=#ffffff>\n";
                    $toggle_color = 1;
                }
           
                // print "$buffer<br>\n";
                print "<td width=90>\n";
                print "$date\n";
                print "</td>\n<td width=250>";
                $packages = explode( ",", $name );
                foreach( $packages as $name )
                {
                    if ( preg_match( "/^bin\//", $name ) )
                    {
                        $binsrc = "bin";
                        $name = preg_replace( "/^bin\//", "", $name );
                    }
                    else
                    {
                        $binsrc = "src";
                    }

                    if ( preg_match( "/\.gar$/", $name ) )
                    {
                        $pkgformat = "gar";
                        $name = preg_replace( "/\.gar$/", "", $name );
                    }
                    else
                    {
                        $pkgformat = "tar.gz";
                    }
                        
                    $name = eregi_replace( "(.+-*[0-9]+.[0-9]*.[0-9]*[\.a-z_]*)", 
                        "<a name=\"\\1\" href=\"http://www.globus.org/ftppub/$version_dir[$ver]/updates/$binsrc/\\1\">\\1</a>", $name );
                    print "$name<br>\n";
                }
                print "</td>\n<td align=middle width=40>";
                print "$ver\n";
                print "</td>\n<td width=20>";
                if ( ereg ( "bug", $type ) )
                {
                    print "<img src=images/bug.gif><br>\n";
                }
                if ( ereg ( "sec", $type ) )
                {
                    print "<img src=images/security.gif><br>\n";
                }
                if ( ereg ( "enh", $type ) )
                {
                    print "<img src=images/enhancement.gif><br>\n";
                }
                print "</td>\n<td>";
                $description = eregi_replace( "bug ([0-9]+)", "<a href=http://bugzilla.globus.org/globus/show_bug.cgi?id=\\1>bug \\1</a>", $description );
                $description = eregi_replace( "(GT|GRAM|RIC|GRIDFTP)-([0-9]+)", "<a href=\"http://jira.globus.org/browse/\\1-\\2\">\\1-\\2</a>", $description );
                print "$description\n";
            }
        }
    }
?>
        </td>
        </tr>
        </table>
    </td>
    </tr>
    </table>
</td>
</tr>
</table>

<!-- Layout Table -->
</tr>
<tr>
<td>
<!-- ------------ -->

<p>
<?php
print "<a href=\"/toolkit/rss/advisories/$get_version.rss\">";
?>
<img src="/toolkit/images/iconRSS.gif" width="35" height="13" border="0"></a>
&nbsp;<a href="http://www.globus.org/toolkit/about_rss.html">What's&nbsp;this?</a>
</p>

</a>

<!-- Key -->
<br>
<table>
<tr>
<td noWrap align="right">
    <img border="0" src="images/security.gif" width="20" height="20">
</td>
<td width="99%">Security</td>
</tr>
<tr>
<td noWrap align="right">
    <img border="0" src="images/bug.gif" width="20" height="20">
</td>
<td>Bug Fix</td>
</tr>
<tr>
<td noWrap align="right">
    <img border="0" src="images/enhancement.gif" width="20" height="20">
    </td>
<td>Enhancement</td>
</tr>
</table>

<!-- Layout Table -->
</td>
</tr>
</table>
<!-- ------------ -->

<?php

function major_release($v)
{
    preg_match("/^(\d+.\d+)/", $v, $matches);
    return $matches[0];
}
include("/mcs/globus.org/include/footer.inc"); ?>
